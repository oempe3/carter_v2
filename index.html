<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Nível do cárter x horas trabalhadas separadoras 2025</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root{
      --bg:#0e1319;
      --panel:#151c24;
      --panel2:#0f172a;
      --muted:#94a3b8;
      --text:#e6edf3;
      --accent:#3b82f6;
      --card:#111827;
      --chip:#0b1220;
      --green:#39ff14;
      --stroke:#1f2937;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text); }
    header{
      display:flex;align-items:center;gap:.8rem;padding:14px 20px;
      background:linear-gradient(90deg,var(--panel),var(--panel2));
      position:sticky;top:0;z-index:10;border-bottom:1px solid var(--stroke);
    }
    header img{height:36px;width:auto}
    header .brand{font-weight:700;letter-spacing:.5px}
    main{max-width:1200px;margin:0 auto;padding:18px}
    .title{font-size:1.1rem;margin:8px 0 14px;color:#cbd5e1}
    .toolbar{
      display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;margin:8px 0 14px;
    }
    .panel{
      background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:10px;
    }
    #chart{height:520px;background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:10px}
    .controls{display:flex;flex-wrap:wrap;gap:10px}
    select, input, button{
      background:#0b1220;border:1px solid var(--stroke);color:var(--text);padding:8px 10px;border-radius:12px;
    }
    button{cursor:pointer}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{background:var(--chip);border:1px solid var(--stroke); padding:6px 10px;border-radius:999px;font-size:.85rem;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin:18px 0 24px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:14px;box-shadow:0 8px 20px rgba(0,0,0,.25)}
    .card h4{margin:0 0 8px;font-size:1rem}
    .card .kvs{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:.92rem}
    .foot{text-align:center;color:#94a3b8;margin:32px 0 14px}
    .row{display:flex;justify-content:space-between;gap:12px;align-items:center;margin:8px 0}
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="UTE Pernambuco III logo"/>
    <div class="brand">UTE PERNAMBUCO III</div>
  </header>
  <main>
    <div class="title">“Nível do cárter x horas trabalhadas separadoras 2025”</div>

    <div class="panel">
      <div class="row">
        <div class="controls">
          <label> Motores:
            <select id="motorSelect" multiple size="6" style="min-width:220px;"></select>
          </label>
          <label> Mostrar todos <input id="toggleAll" type="checkbox"/></label>
          <label> Início <input id="dateStart" type="date"/></label>
          <label> Fim <input id="dateEnd" type="date"/></label>
          <button id="btnPlot">Plotar</button>
        </div>
        <div>
          <button id="btnExport">Exportar janela para CSV</button>
        </div>
      </div>
      <div class="chips" id="chips"></div>
      <div id="chart"></div>
    </div>

    <h3 style="margin:18px 0 8px">Resumo por motor</h3>
    <div id="cards" class="grid"></div>

    <div class="foot">O&amp;M Pernambuco III</div>
  </main>

<script>
(async function(){
  // Load
  const data = await d3.csv("data.csv", d3.autoType);
  function normMotor(m){
    const s = (m??"").toString();
    const num = s.match(/\d+/);
    return num ? `Motor#${String(parseInt(num[0])).padStart(2,"0")}` : (s||"Motor#01");
  }
  data.forEach(d=>{
    d.Motor = normMotor(d.Motor);
    d.Data = new Date(d.DataISO ?? d.Data);
    d.Nivel_RDO = +d.Nivel_RDO;
    d.Nivel_Insp = (d.Nivel_Insp==null || d.Nivel_Insp==='') ? null : +d.Nivel_Insp;
    d.Hora = (d.Hora==null || d.Hora==='') ? null : +d.Hora;
  });

  // UI elements
  const motorSelect = document.getElementById("motorSelect");
  const toggleAll = document.getElementById("toggleAll");
  const chips = document.getElementById("chips");
  const dateStart = document.getElementById("dateStart");
  const dateEnd = document.getElementById("dateEnd");
  const btnPlot = document.getElementById("btnPlot");
  const btnExport = document.getElementById("btnExport");

  const motors = Array.from(new Set(data.map(d=>d.Motor))).sort();
  motors.forEach(m=>{
    const opt = document.createElement("option");
    opt.value = m; opt.textContent = m;
    motorSelect.appendChild(opt);
  });
  toggleAll.checked = true;
  for (const opt of motorSelect.options) opt.selected = true;

  const minDate = new Date(Math.min(...data.map(d=>+d.Data)));
  const maxDate = new Date(Math.max(...data.map(d=>+d.Data)));
  dateStart.valueAsDate = minDate;
  dateEnd.valueAsDate = maxDate;

  function selectedMotors(){
    return Array.from(motorSelect.selectedOptions).map(o=>o.value);
  }
  function renderChips(sel){
    chips.innerHTML = "";
    sel.forEach(m=>{
      const div = document.createElement("div");
      div.className = "chip";
      div.textContent = m;
      div.onclick = ()=>{
        for (const opt of motorSelect.options) opt.selected = (opt.value===m);
        toggleAll.checked = false;
        plot();
      };
      chips.appendChild(div);
    });
  }
  renderChips(motors);

  toggleAll.addEventListener("change", e=>{
    const all = e.target.checked;
    for (const opt of motorSelect.options) opt.selected = all;
    plot();
  });
  btnPlot.addEventListener("click", plot);
  motorSelect.addEventListener("change", ()=>{ renderChips(selectedMotors()); });

  function colorFor(i){
    const palette = ["#22c1c3","#f7931e","#f72585","#00c853","#ffd166","#06d6a0","#118ab2","#ef476f","#a2d2ff","#b5179e","#ff7f50","#90ee90","#87cefa","#dda0dd","#f4a460","#32cd32","#9acd32","#20b2aa","#9370db","#ff1493","#00bcd4","#ffb703","#fb8500"];
    return palette[i % palette.length];
  }
  function formatTooltipVal(v){ return (v==null || isNaN(v)) ? "—" : d3.format(".2f")(v); }
  function calcHorasAno(row, g){
    const year = row.Data.getFullYear();
    const gYear = g.filter(x=>x.Data.getFullYear()===year);
    if (row.Hora==null || gYear.length===0) return null;
    const minHora = d3.min(gYear, d=>d.Hora==null? Infinity : d.Hora);
    if (minHora===Infinity) return null;
    return (row.Hora - minHora);
  }
  function calcHorasMes(row, g){
    const same = g.filter(x=>x.Data <= row.Data);
    if (same.length<2 || row.Hora==null) return null;
    const prev = same[same.length-2];
    if (!prev || prev.Hora==null) return null;
    return (row.Hora - prev.Hora);
  }

  function buildTraces(filtered){
    const traces = [];
    const grouped = d3.group(filtered, d=>d.Motor);
    let i=0;
    for (const [motor, arr] of grouped){
      const g = Array.from(arr).sort((a,b)=>a.Data-b.Data);
      const xs = g.map(d=>d.Data);
      const ys = g.map(d=>d.Nivel_RDO);
      const insp = g.map(d=>d.Nivel_Insp);
      const horas = g.map(d=>d.Hora);
      const horasAno = g.map(d=>calcHorasAno(d, g));
      const horasMes = g.map(d=>calcHorasMes(d, g));
      const col = colorFor(i++);
      traces.push({
        x: xs, y: ys, mode:"lines+markers", name: motor,
        line: {shape:"spline", width:2, color: col},
        marker: {size:5, color: col},
        text: horas.map(h => h==null? "" : d3.format(".0f")(h)),
        textposition: "top left",
        hovertemplate:
          `<b>${motor}</b><br>`+
          `%{x|%d/%m/%Y}` + `<br>` +
          `RDO: %{y:.2f} cm<br>` +
          `Inspeção: %{customdata[0]} cm<br>` +
          `H_inspeção: %{customdata[1]} h<br>` +
          `Dif_cm: %{customdata[2]} cm<br>` +
          `Horas ano: %{customdata[3]} h<br>` +
          `Horas mês: %{customdata[4]} h<extra></extra>`,
        customdata: insp.map((d,idx)=>[
          formatTooltipVal(d),
          (horas[idx]==null||isNaN(horas[idx]))? "—" : d3.format(".0f")(horas[idx]),
          (d==null||isNaN(d)||ys[idx]==null||isNaN(ys[idx]))? "—" : d3.format(".2f")(ys[idx]-d),
          (horasAno[idx]==null||isNaN(horasAno[idx]))? "—" : d3.format(".0f")(horasAno[idx]),
          (horasMes[idx]==null||isNaN(horasMes[idx]))? "—" : d3.format(".0f")(horasMes[idx])
        ]),
      });
    }
    return traces;
  }

  function verticalLines(dates){
    return dates.map(d=>({
      type:"line", x0:d, x1:d, y0:0, y1:1, xref:"x", yref:"paper",
      line: {color:"#39ff14", width:1, dash:"dot"}
    }));
  }

  function plot(){
    const sel = selectedMotors();
    const start = dateStart.value ? new Date(dateStart.value) : null;
    const end = dateEnd.value ? new Date(dateEnd.value) : null;
    const filtered = data.filter(d=> (sel.includes(d.Motor)) && (!start || d.Data>=start) && (!end || d.Data<=end));

    const udates = Array.from(new Set(filtered.map(d=>+d.Data))).sort((a,b)=>a-b).slice(0,10).map(t=>new Date(t));
    const traces = buildTraces(filtered);
    const layout = {
      paper_bgcolor: "rgba(0,0,0,0)",
      plot_bgcolor: "rgba(0,0,0,0)",
      xaxis: {gridcolor:"#223042", tickformat:"%d/%m/%Y"},
      yaxis: {gridcolor:"#223042", title:"Nível do cárter (cm)"},
      margin: {l:50,r:20,t:20,b:50},
      legend: {orientation:"h", y:-0.2},
      shapes: verticalLines(udates)
    };
    Plotly.newPlot("chart", traces, layout, {responsive:true, displaylogo:false, modeBarButtonsToRemove:["select2d","lasso2d"]});
  }

  // Export only plotted window
  btnExport.addEventListener("click", async ()=>{
    const gd = document.getElementById("chart");
    const fig = gd.data || [];
    const xRange = (gd.layout && gd.layout.xaxis && gd.layout.xaxis.range) ? gd.layout.xaxis.range : null;
    let start = dateStart.value ? new Date(dateStart.value) : null;
    let end = dateEnd.value ? new Date(dateEnd.value) : null;
    if (xRange && xRange.length===2){
      start = new Date(xRange[0]);
      end = new Date(xRange[1]);
    }
    // Collect rows from original data that match current selection/time window
    const sel = selectedMotors();
    const filtered = data.filter(d=> (sel.includes(d.Motor)) && (!start || d.Data>=start) && (!end || d.Data<=end));
    const header = ["Data","Motor","Nivel_RDO","Nivel_Insp","Hora"];
    const rows = filtered.map(d=>[d3.timeFormat("%d/%m/%Y")(d.Data), d.Motor, d.Nivel_RDO, (d.Nivel_Insp==null?"":d.Nivel_Insp), (d.Hora==null?"":d.Hora)]);
    const csv = [header.join(","), ...rows.map(r=>r.join(","))].join("\n");
    const blob = new Blob([csv], {{type:"text/csv;charset=utf-8;"}});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "janela_plot.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  plot();

  // Build cards
  const summary = await fetch("summary.json").then(r=>r.json());
  const cards = document.getElementById("cards");
  const colorIndexByMotor = new Map(Array.from(motors, (m,i)=>[m, i]));
  function val(v, suffix=""){ return (v===null || v===undefined) ? "—" : v + suffix; }
  summary.sort((a,b)=> (a.Motor>b.Motor?1:-1));
  for (const row of summary){
    const color = colorFor(colorIndexByMotor.get(row.Motor)||0);
    const el = document.createElement("div");
    el.className="card";
    el.innerHTML = `
      <h4 style="display:flex;align-items:center;gap:8px">
        <span style="display:inline-block;width:12px;height:12px;border-radius:999px;background:${color}"></span>
        ${row.Motor} 2025
      </h4>
      <div class="kvs">
        <div>Consumo de OL [RDO]:</div><div><b>${val(row.Consumo_RDO_L," L")}</b></div>
        <div>Consumo de OL [Inspeção]:</div><div><b>${val(row.Consumo_Insp_L," L")}</b></div>
        <div>H:</div><div><b>${val(row.Horas," h")}</b></div>
        <div>L/H:</div><div><b>${val(row.LH)}</b></div>
      </div>`;
    cards.appendChild(el);
  }
})();
</script>
</body>
</html>
